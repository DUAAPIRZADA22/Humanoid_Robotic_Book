openapi: 3.0.3
info:
  title: Chat Widget API
  description: API for the Physical AI & Humanoid Robotics book chat widget
  version: 1.0.0
  contact:
    name: API Support
servers:
  - url: https://api.example.com/v1
    description: Production server
  - url: http://localhost:7860/v1
    description: Development server

security:
  - ApiKeyAuth: []

paths:
  /chat:
    post:
      tags:
        - Chat
      summary: Send a chat message
      description: Send a message to the AI assistant and receive a response
      operationId: sendMessage
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
            examples:
              simple_question:
                summary: Simple question
                value:
                  question: "What is physical AI?"
                  stream: true
              context_question:
                summary: Question with selected text
                value:
                  question: "Explain this concept"
                  context:
                    selectedText: "Physical AI refers to embodied artificial intelligence systems that interact with the physical world"
                    pageUrl: "/docs/intro"
                    pageTitle: "Introduction"
                  stream: true
      responses:
        '200':
          description: Successful response (non-streaming)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
              examples:
                successful_response:
                  summary: AI response
                  value:
                    sessionId: "sess_123456"
                    response:
                      id: "msg_789"
                      content: "Physical AI is..."
                      role: "assistant"
                      timestamp: "2025-12-07T10:30:00Z"
                    usage:
                      promptTokens: 25
                      completionTokens: 150
                      totalTokens: 175
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /chat/stream:
    post:
      tags:
        - Chat
      summary: Stream a chat response
      description: Send a message and receive a streaming response via Server-Sent Events
      operationId: streamMessage
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
      responses:
        '200':
          description: Successful streaming response
          content:
            text/event-stream:
              schema:
                type: string
                example: |
                  data: {"type": "start", "sessionId": "sess_123456"}

                  data: {"type": "chunk", "content": "Physical"}

                  data: {"type": "chunk", "content": " AI is"}

                  data: {"type": "chunk", "content": "..."}

                  data: {"type": "done", "sessionId": "sess_123456"}
              examples:
                streaming_response:
                  summary: Example stream
                  value: |
                    data: {"type": "start", "sessionId": "sess_123456"}
                    data: {"type": "chunk", "content": "Hello"}
                    data: {"type": "chunk", "content": "!"}
                    data: {"type": "done", "sessionId": "sess_123456"}
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /health:
    get:
      tags:
        - System
      summary: Health check
      description: Check if the API is healthy
      operationId: healthCheck
      responses:
        '200':
          description: API is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for authentication

  schemas:
    ChatRequest:
      type: object
      required:
        - question
        - stream
      properties:
        question:
          type: string
          minLength: 1
          maxLength: 10000
          description: The user's question or message
          example: "What is physical AI?"
        context:
          $ref: '#/components/schemas/RequestContext'
        stream:
          type: boolean
          description: Whether to stream the response
          default: true
        sessionId:
          type: string
          description: Optional session ID for conversation continuity
          example: "sess_123456"
      example:
        question: "What is physical AI?"
        stream: true

    RequestContext:
      type: object
      properties:
        selectedText:
          type: string
          maxLength: 2000
          description: Text selected by the user
          example: "Physical AI refers to embodied AI systems"
        pageUrl:
          type: string
          format: uri
          description: Current page URL
          example: "/docs/chapter-1"
        pageTitle:
          type: string
          description: Current page title
          example: "Chapter 1: Introduction to Physical AI"

    ChatMessage:
      type: object
      required:
        - id
        - content
        - role
        - timestamp
      properties:
        id:
          type: string
          description: Unique message identifier
          example: "msg_123456"
        content:
          type: string
          description: Message content (may contain markdown)
          example: "Physical AI is..."
        role:
          type: string
          enum: [user, assistant, system]
          description: Role of the message sender
          example: "assistant"
        timestamp:
          type: string
          format: date-time
          description: Message timestamp
          example: "2025-12-07T10:30:00Z"
        metadata:
          $ref: '#/components/schemas/MessageMetadata'

    MessageMetadata:
      type: object
      properties:
        selectedText:
          type: string
          description: Original text selection that prompted this message
        context:
          type: string
          description: Page context for the message
        tokens:
          type: integer
          description: Number of tokens in the message
          minimum: 0

    ChatResponse:
      type: object
      required:
        - sessionId
        - response
      properties:
        sessionId:
          type: string
          description: Session identifier
          example: "sess_123456"
        response:
          $ref: '#/components/schemas/ChatMessage'
        usage:
          $ref: '#/components/schemas/TokenUsage'

    StreamingChunk:
      type: object
      required:
        - type
        - timestamp
      properties:
        type:
          type: string
          enum: [start, chunk, error, done]
          description: Type of streaming chunk
        content:
          type: string
          description: Content chunk (only for type: 'chunk')
          example: "Physical"
        error:
          type: string
          description: Error message (only for type: 'error')
          example: "Connection lost"
        sessionId:
          type: string
          description: Session identifier
          example: "sess_123456"
        timestamp:
          type: string
          format: date-time
          description: Chunk timestamp
          example: "2025-12-07T10:30:00Z"

    TokenUsage:
      type: object
      required:
        - promptTokens
        - completionTokens
        - totalTokens
      properties:
        promptTokens:
          type: integer
          minimum: 0
          description: Number of tokens in the prompt
          example: 25
        completionTokens:
          type: integer
          minimum: 0
          description: Number of tokens in the completion
          example: 150
        totalTokens:
          type: integer
          minimum: 0
          description: Total number of tokens
          example: 175

    HealthResponse:
      type: object
      required:
        - status
        - timestamp
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
          description: Health status
          example: "healthy"
        version:
          type: string
          description: API version
          example: "1.0.0"
        timestamp:
          type: string
          format: date-time
          description: Health check timestamp
          example: "2025-12-07T10:30:00Z"

    ErrorResponse:
      type: object
      required:
        - error
        - timestamp
      properties:
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              description: Error code
              example: "INVALID_REQUEST"
            message:
              type: string
              description: Human-readable error message
              example: "The request was invalid"
            details:
              type: object
              description: Additional error details
        timestamp:
          type: string
          format: date-time
          description: Error timestamp
          example: "2025-12-07T10:30:00Z"

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            invalid_request:
              summary: Invalid request
              value:
                error:
                  code: "INVALID_REQUEST"
                  message: "The request was invalid"
                  details:
                    field: "question"
                    issue: "required field missing"
                timestamp: "2025-12-07T10:30:00Z"

    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            missing_api_key:
              summary: Missing API key
              value:
                error:
                  code: "UNAUTHORIZED"
                  message: "API key is required"
                timestamp: "2025-12-07T10:30:00Z"

    TooManyRequests:
      description: Too many requests
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            rate_limited:
              summary: Rate limit exceeded
              value:
                error:
                  code: "RATE_LIMITED"
                  message: "Too many requests. Please try again later."
                  details:
                    retryAfter: 60
                timestamp: "2025-12-07T10:30:00Z"

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            server_error:
              summary: Internal error
              value:
                error:
                  code: "INTERNAL_ERROR"
                  message: "An unexpected error occurred"
                timestamp: "2025-12-07T10:30:00Z"

tags:
  - name: Chat
    description: Chat operations
  - name: System
    description: System health operations